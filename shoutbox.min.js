var shoutBox=function(){function o(){var o=["Small","Blue","Fatty","Pink"],e=["Bear","Potato","Banana","Kiwi"],s=Math.floor(Math.random()*o.length),t=Math.floor(Math.random()*e.length);return o[s]+e[t]}function e(){return void 0===$rootScope.appConfig||$rootScope.appConfig.loggedIn===!1?(setTimeout(function(){e()},5e3),!1):(console.log("shoutBox module loaded"),void $(function(){n(),$(".shoutbox").show(),$(".shoutbox__header").on("click",function(o){s()}),$("#shoutbox__new_message").keypress(function(o){if(13==o.which){var e=$(this).val();l(e),$(this).val("")}}),g=$rootScope.appConfig.user.displayName||$rootScope.appConfig.login||o(),c=$rootScope.appConfig.login||"unknown"}))}function s(){var o=t();$(".shoutbox__body").slideToggle(200,function(){"open"==o?(a({shoutbox_is_open:!1}),$(".shoutbox__header i").attr("class","icon-circle-arrow-up")):(a({shoutbox_is_open:!0,unread_message:!1}),$(".shoutbox__header i").attr("class","icon-circle-arrow-down"))})}function t(){return"block"===$(".shoutbox__body").css("display")?"open":"closed"}function n(){var o={volume_is_on:!0,shoutbox_is_open:!0,unread_message:!1};if("undefined"==typeof localStorage||null===localStorage.getItem("shoutbox.settings"))a(o);else{console.log("loading existing settings");var e=JSON.parse(localStorage.getItem("shoutbox.settings"));console.log(e);var s=$.extend({},o,e);a(s)}}function a(o){if(console.log("Settings saved"),console.log(o),"object"==typeof o&&null!==o){for(var e in o)h[e]=o[e];if("undefined"!=typeof localStorage){var s=JSON.parse(localStorage.getItem("shoutbox.settings"));angular.equals(s,h)||localStorage.setItem("shoutbox.settings",JSON.stringify(h))}i()}}function i(){h.shoutbox_is_open!==("open"===t())&&s(),h.unread_message!==$(".shoutbox__header").hasClass("unread")&&$(".shoutbox__header").toggleClass("unread")}function r(o,e,s){var t=(new Date).toLocaleTimeString().toString(),n='<div class="shoutbox__message"><img src="/dip/api/image/get-image?type=USER&id='+e+"&size=20x20&hash="+$rootScope.userPicturesHash+'" alt="" /><span class="name">'+o+'</span><span class="time">'+t+"</span>"+s+"</div>";$(".shoutbox__messages").append(n).children(":last").hide().fadeIn();var a=$(".shoutbox__messages")[0].scrollHeight;$(".shoutbox__messages").scrollTop(a)}function l(o){r(g,c,o),Notification.broadcastToOtherSessions("shoutbox-receive-message",{from_name:g,from_id:c,message:o})}function u(){$("#shoutbox__sound").trigger("play")}var g="Unknown",c="unknown",h={};return window.addEventListener("storage",function(o){"shoutbox.settings"===o.key&&(console.log("Settings updated (from another window)"),console.log(o.newValue),h=JSON.parse(o.newValue),i())}),Notification.registerEvent("shoutbox-receive-message",function(o,e){r(e.from_name,e.from_id,e.message),e.from_name!==g&&(u(),"closed"==t()&&a({unread_message:!0}))}),{init:e,toggleDisplay:s}}();shoutBox.init();
